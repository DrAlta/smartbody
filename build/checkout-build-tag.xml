<?xml version="1.0" encoding="UTF-8"?>
<project name="masterbuild" default="all" basedir=".">

    <!-- set ANT_OPTS=-Xms512m -Xmx1g -->
    <!-- need ant-contrib-1.0b3.jar in c:\apache-ant-1.7.0\lib dir -->
    <!-- need antcount.jar in c:\apache-ant-1.7.0\lib dir -->

    <!-- ant -Dsvn.password=blah -Dbuild.suffix=-ci -->


    <!-- this script performs the following tasks:
         - check to see if a previous build is running, and quits if so
         - create a timestamp file to indicate when this build has run
         - svn checkout (or update) from repository to sandbox directory
         - export sandbox to build directory
         - compile project
         - move the build to final destination
         - gather directory statistics
         - filter revision numbers from svn output
         - filter errors and warnings from compiler output
         - generate email report
         - tag repository with email report
         - generate build output
    -->


    <typedef resource="net/sf/antcontrib/antlib.xml"/>
    <typedef resource="net/sf/antcount/antlib.xml"/>


    <property name="build.suffix" value=""/>
    <property name="tag.svn" value="no"/>
    <property name="email.report" value="yes"/>
    <property name="email.host" value="localhost"/>
    <property name="email.from" value="blah@example.com"/>
    <property name="email.to" value="blah@example.com"/>
    <property name="destination.folder" value="D:\SBM-Builds"/>


    <target name="all" depends="clean,build" description="Full build"></target>


    <target name="clean.sandbox" depends="clean">
        <!-- check to see if the build is running and quit out if it is -->
        <available file="BUILD_RUNNING" property="build.running"/>
        <fail if="build.running" message="Build is already running!"/>

        <delete dir="./build.sandbox"/>
    </target>


    <target name="clean">
        <!-- check to see if the build is running and quit out if it is -->
        <available file="BUILD_RUNNING" property="build.running"/>
        <fail if="build.running" message="Build is already running!"/>

        <delete dir="./build"/>
    </target>


    <target name="build">

        <stopwatch name="total.build.time"/>

        <!-- check to see if the build is running and quit out if it is -->
        <available file="BUILD_RUNNING" property="build.running"/>
        <fail if="build.running" message="Build is already running!"/>


        <!-- create the build running file, and update the timestamp file -->
        <touch file="BUILD_RUNNING"/>
        <tstamp><format property="build.time.file" pattern="yyyy-MM-dd HH:mm:ss"/></tstamp>
        <echo file="BUILD_TIME" message="${build.time.file}"/>


        <stopwatch name="build.svn.time"/>

        <!-- checkout/update build from svn into sandbox -->
        <echo message="--- Starting build.svn.checkout..."/>
        <if>
            <available file="build.sandbox" type="dir" />
            <then>
                <exec executable="svn.exe" outputproperty="build.svn.output">
                    <arg line="update build.sandbox"/>
                </exec>
            </then>
            <else>
                <exec executable="svn.exe" outputproperty="build.svn.output">
                    <arg line="checkout --non-interactive https://smartbody.svn.sourceforge.net/svnroot/smartbody/trunk build.sandbox"/>
                </exec>
                <property name="build.svn.clean.checkout" value="1"/>
            </else>
        </if>

        <stopwatch name="build.svn.time" action="total"/>


        <stopwatch name="build.export.time"/>

        <echo message="--- Starting build.svn..."/>
        <exec executable="svn.exe" outputproperty="build.svn.export.output">
            <arg line="export --non-interactive build.sandbox build"/>
        </exec>

        <stopwatch name="build.export.time" action="total"/>


        <!-- compile -->
        <echo message="--- Starting build.compile..."/>
        <stopwatch name="build.compile.time"/>
        <exec executable="cmd.exe" dir="build" outputproperty="build.compile.output">
            <arg line="/c compile-sbm.bat"/>
        </exec>
        <stopwatch name="build.compile.time" action="total"/>


        <!-- filter out revision numbers from svn output -->

        <echo message="--- Analyzing output..."/>

        <if>
            <isset property="build.svn.clean.checkout"/>
            <then>
                <loadresource property="build.svn.revisions">
                    <propertyresource name="build.svn.output"/>
                    <filterchain>
                        <linecontainsregexp>
                            <regexp pattern="(Checked out revision |Fetching external item into |Checked out external at )"/>
                        </linecontainsregexp>
                        <prefixlines prefix="   "/>
                        <countfilter property="build.svn.revisions.count"/>
                    </filterchain>
                </loadresource>
            </then>
            <else>
                <loadresource property="build.svn.revisions">
                    <propertyresource name="build.svn.output"/>
                    <filterchain>
                        <linecontainsregexp>
                            <regexp pattern="(Updated external to revision |Fetching external item into |Updated to revision |External at revision |At revision )"/>
                        </linecontainsregexp>
                        <prefixlines prefix="   "/>
                        <countfilter property="build.svn.revisions.count"/>
                    </filterchain>
                </loadresource>
            </else>
        </if>

        <!-- assume the last line is the actual revision of the export -->
        <loadresource property="build.svn.revision.rev1">
            <propertyresource name="build.svn.revisions"/>
            <filterchain>
               <tailfilter lines="1"/>
            </filterchain>
        </loadresource>

        <if>
            <isset property="build.svn.clean.checkout"/>
            <then>
                <propertyregex property="build.svn.revision" input="${build.svn.revision.rev1}" regexp="(.*)Checked out revision (\d+)(.*)" select="\2" />
            </then>
            <else>
                <propertyregex property="build.svn.revision" input="${build.svn.revision.rev1}" regexp="(.*)(Updated to revision |At revision )(\d+)(.*)" select="\3" />
            </else>
        </if>
        <echo message="build revision: ${build.svn.revision}"/>


        <!-- filter out compiler errors and warnings -->

        <!-- ": warning " -->
        <!-- ": error " -->
        <!-- ": fatal error " -->

        <loadresource property="build.compile.errors" failonerror="false">
            <propertyresource name="build.compile.output"/>
            <filterchain>
                <linecontainsregexp>
                    <regexp pattern="(.*)(: error |: fatal error )(.*)"/>
                </linecontainsregexp>
                <prefixlines prefix="   "/>
                <countfilter property="build.compile.errors.count" />
            </filterchain>
        </loadresource>

        <loadresource property="build.compile.warnings" failonerror="false">
            <propertyresource name="build.compile.output"/>
            <filterchain>
                <linecontainsregexp>
                    <regexp pattern="(.*): warning (.*)"/>
                </linecontainsregexp>
                <prefixlines prefix="   "/>
                <countfilter property="build.compile.warnings.count" />
            </filterchain>
        </loadresource>


        <!-- determine if build succeeded by looking for compiler errors -->
        <if>
            <not><isset property="build.compile.errors"/></not>
            <then>
                <property name="build.success" value="1"/>
                <echo message="Build Success."/>
            </then>
        </if>


        <buildnumber/>
        <echo message="build: ${build.number}"/>

        <tstamp><format property="build.date" pattern="MM-dd-yyyy"/></tstamp>
        <echo message="date: ${build.date}"/>

        <if>
            <isset property="build.success"/>
            <then>
                <property name="build.folder.name" value="Build${build.number}-${build.date}${build.suffix}"/>
            </then>
            <else>
                <property name="build.folder.name" value="Build${build.number}-${build.date}${build.suffix}-failed"/>
            </else>
        </if>
        <echo message="folder.name: ${build.folder.name}"/>

        <property name="build.folder" value="${destination.folder}\${build.folder.name}"/>
        <echo message="folder: ${build.folder}"/>


        <!-- move build to its destination folder -->
        <mkdir dir="${build.folder}"/>
        <move file="build" todir="${build.folder}"/>
        <move file="${build.folder}/build" tofile="${build.folder}/smartbody"/>


        <echo message="--- Starting directory statistics..."/>
        <length property="dir.size.total">
            <fileset dir="${build.folder}"/>
        </length>

        <resourcecount property="num.files.total">
            <fileset dir="${build.folder}"/>
        </resourcecount>

        <resourcecount property="num.dirs.total">
            <dirset dir="${build.folder}"/>
        </resourcecount>


        <echo message="size:  ${dir.size.total}"/>
        <echo message="files: ${num.files.total}"/>
        <echo message="dirs:  ${num.dirs.total}"/>


        <stopwatch name="total.build.time" action="total"/>


        <!-- generate output to be used in email report -->

        <property name="final.mail.file" value="${build.folder}/FinalMail.txt"/>

        <concat destfile="${final.mail.file}" append="no">build: Automatically tagging r${build.svn.revision} as Build #${build.number}

Build Summary:
</concat>
        <if>
            <isset property="build.success"/>
            <then>
                <concat destfile="${final.mail.file}" append="yes">   Build Success.</concat>
            </then>
            <else>
                <concat destfile="${final.mail.file}" append="yes">   Build FAILED!!</concat>
            </else>
        </if>

        <concat destfile="${final.mail.file}" append="yes">

Broken projects:
</concat>
        <if><isset property="build.compile.errors"/><then><concat destfile="${final.mail.file}" append="yes">${build.compile.errors}</concat></then></if>
        <concat destfile="${final.mail.file}" append="yes">
Dirty projects:
</concat>
        <if><isset property="build.compile.warnings"/><then><concat destfile="${final.mail.file}" append="yes">${build.compile.warnings}</concat></then></if>

        <concat destfile="${final.mail.file}" append="yes">

Build ${build.number} took ${total.build.time}
   build.svn.time ${build.svn.time}
   build.export.time ${build.export.time}
   build.compile.time ${build.compile.time}

Build size: ${dir.size.total} (${num.files.total} files, ${num.dirs.total} dirs)

Build is available at \\vhbuild\SBM-Builds\${build.folder.name}

Log: \\vhbuild\SBM-Builds\${build.folder.name}\BuildLog.txt

Revisions used:
saso revisions (based off of r${build.svn.revision}):
${build.svn.revisions}
</concat>

        <fixcrlf file="${final.mail.file}"/>


        <!-- tag the repositories with the email report -->
        <if>
            <istrue value="${tag.svn}"/>
            <then>
            </then>
        </if>

        <if>
            <istrue value="${email.report}"/>
            <then>
                <mail mailhost="${email.host}" from="${email.from}" tolist="${email.to}" subject="[SBM] Build Results" messagefile="${final.mail.file}"/>
            </then>
        </if>


        <!-- <delete file="${final.mail.file}"/> -->


        <!-- generate output for log file -->

        <property name="build.log.file" value="${build.folder}/BuildLog.txt"/>

        <concat destfile="${build.log.file}" force="yes" append="yes">
------------------

${build.svn.output}

        </concat>

        <concat destfile="${build.log.file}" force="yes" append="yes">
------------------

${build.svn.export.output}

        </concat>

        <concat destfile="${build.log.file}" force="yes" append="yes">
------------------

${build.compile.output}

        </concat>


        <delete file="BUILD_RUNNING"/>

    </target>

</project>
